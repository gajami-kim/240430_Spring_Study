package com.ezen.test.controller;

import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.request;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpSession;

import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestMapping;

import com.ezen.test.domain.MemberVO;
import com.ezen.test.service.MemberService;

import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;

@Slf4j
@RequiredArgsConstructor
@RequestMapping("/member/*")
@Controller
public class MemberController {
		
	private final MemberService msv;

	@GetMapping("/register")
	public void register() {}

	@PostMapping("/register")
	public String register(MemberVO mvo) {
		log.info(">>>> mvo >>>> {}", mvo);
		int isOk = msv.insert(mvo);
		log.info(">>>> isOk >>>> {}", isOk);
		return "index";
	}
	
	@GetMapping("/login")
	public void login() {}
	
	@PostMapping("/login")
	public String login(MemberVO mvo, HttpServletRequest request, Model m) {
		log.info(">>>> login >>>> {}", mvo);
		
		//mvo 객체가 DB의 값과 일치하면 객체를 가져옴(세션에 저장(로그인행위))
		MemberVO loginmvo = msv.isUser(mvo);
		log.info(">>>> login mvo >>>> {}", loginmvo);
		
		if(loginmvo!=null) {
			//로그인 성공시
			HttpSession ses = request.getSession();
			ses.setAttribute("ses", loginmvo); //세션에 로그인객체 저장
		} else {
			m.addAttribute("msg_login", "1");
		}
		return "index";
	}
	
	@GetMapping("/logout")
	public String logout(HttpServletRequest request, Model m) {
		//라스트로그인 업데이트 => 세션 객체 삭제 => 세션끊기
		MemberVO mvo = (MemberVO) request.getSession().getAttribute("ses");
		msv.last_loginUpdate(mvo.getId());
		
		request.getSession().removeAttribute("ses"); //ses 세션 삭제
		request.getSession().invalidate(); //세션 끊기
		
		m.addAttribute("msg_logout", "1");
		return "index";
	}
	
}

























